<?xml version="1.0"?>

<project xmlns:antcontrib="antlib:net.sf.antcontrib" xmlns:artifact="antlib:org.apache.maven.artifact.ant" xmlns:ivy="antlib:org.apache.ivy.ant" name="Build script for IDE users" basedir=".." default="theme-and-client-engine">
    <property name="work.dir" location="work" />
    <property file="build.properties" />

    <!-- Setting this to 0 disables the parallel compilation -->
    <property name="threadsPerProcessor" value="1" />

    <target name="resolve" unless="resolve.done">
        <ivy:resolve log="download-only" file="server/ivy.xml" conf="ide" />
        <ivy:cachepath pathid="server.deps" conf="ide" />
        <ivy:resolve log="download-only" file="client/ivy.xml" conf="ide" />
        <ivy:cachepath pathid="client.deps" conf="ide" />
        <ivy:resolve log="download-only" file="shared/ivy.xml" conf="ide" />
        <ivy:cachepath pathid="shared.deps" conf="ide" />
        <ivy:resolve log="download-only" file="uitest/ivy.xml" conf="ide" />
        <ivy:cachepath pathid="uitest.deps" conf="ide" />
        <ivy:resolve log="download-only" file="buildhelpers/ivy.xml" />
        <ivy:cachepath pathid="buildhelpers.deps" />

        <path id="classpath">
            <path location="build/classes" />
            <path refid="shared.deps" />
            <path refid="client.deps" />
            <path location="shared/src" />
            <path location="client/src" />
        </path>
    	<path id="buildhelpers">
            <path refid="buildhelpers.deps" />
   		</path>
        <property name="resolve.done" value="true" />
    </target>

    <target name="theme-and-client-engine" depends="resolve">
        <!-- threadCount is ignored unless threadsPerProcessor is 0 -->
        <parallel threadsPerProcessor="${threadsPerProcessor}" threadCount="1">
            <antcall target="client-engine" inheritRefs="true" />
            <antcall target="themes" inheritRefs="true" />
            <antcall target="vaadinPush.js" inheritRefs="true" />
        </parallel>
    </target>

    <target name="themes" depends="resolve">
        <!-- threadCount is ignored unless threadsPerProcessor is 0 -->
        <parallel threadsPerProcessor="${threadsPerProcessor}" threadCount="1">
            <antcall target="compile-theme" inheritRefs="true">
                <param name="theme" value="valo" />
            </antcall>
<!-- Disabled during development
            <antcall target="compile-theme" inheritRefs="true">
                <param name="theme" value="tests-valo" />
            </antcall>
            <antcall target="compile-theme" inheritRefs="true">
                <param name="theme" value="tests-valo-dark" />
            </antcall>
            <antcall target="compile-theme" inheritRefs="true">
                <param name="theme" value="tests-valo-metro" />
            </antcall>
            <antcall target="compile-theme" inheritRefs="true">
                <param name="theme" value="tests-valo-flat" />
            </antcall>
            <antcall target="compile-theme" inheritRefs="true">
                <param name="theme" value="tests-valo-flatdark" />
            </antcall>
            <antcall target="compile-theme" inheritRefs="true">
                <param name="theme" value="tests-valo-facebook" />
            </antcall>
            <antcall target="compile-theme" inheritRefs="true">
                <param name="theme" value="tests-valo-blueprint" />
            </antcall>
            <antcall target="compile-theme" inheritRefs="true">
              <param name="theme" value="tests-valo-light" />
            </antcall>
            <antcall target="compile-theme" inheritRefs="true">
              <param name="theme" value="tests-valo-disabled-animations" />
            </antcall>
-->
        </parallel>
    </target>

    <target name="compile-theme" depends="resolve">
        <java classname="com.vaadin.buildhelpers.CompileTheme" failonerror="yes" fork="yes">
            <classpath refid="classpath" />
            <classpath refid="buildhelpers" />
            <jvmarg value="-Djava.awt.headless=true" />
            <arg value="--theme" />
            <arg value="${theme}" />
            <arg value="--theme-folder" />
            <arg value="WebContent/VAADIN/themes" />
            <arg value="--version" />
            <arg value="${vaadin.version}" />
        </java>

    </target>


    <target name="client-engine">
        <antcall target="compile-module" inheritRefs="true">
            <param name="module" value="com.vaadin.ClientEngine" />
        </antcall>
    </target>

    <target name="compile-module" depends="resolve">
        <property name="module" value="${module}" />
        <property name="module.output.dir" location="WebContent/VAADIN/gwt" />
        <property name="logLevel" value="TRACE" />
        <property name="style" value="OBF" />
        <property name="localWorkers" value="2" />
        <!-- Whether assertions should be compiled into the client engine. 
             Either "-ea" to enable or "" to disable. -->
        <property name="assertions" value="-ea" />
        <property name="extraParams" value="-soyc" />
        
        <property name="gwt.usearchives" value="true" />
        <property name="gwt.persistentunitcache" value="false" />

        <mkdir dir="${module.output.dir}" />

        <echo>Compiling ${module} to ${module.output.dir} with parameters -logLevel ${logLevel} -style ${style} -localWorkers ${localWorkers} ${assertions} -strict ${extraParams}</echo>

        <!--<ivy:resolve log="download-only" inline="true" organisation="javax.validation" module="validation-api" 
            revision="1.0.0.GA"/> -->

        <!-- compile the module -->
        <java classname="com.google.gwt.dev.Compiler" classpathref="classpath" failonerror="yes" fork="yes" maxmemory="512m">
            <arg value="-workDir" />
            <arg value="${work.dir}" />
            <arg value="-logLevel" />
            <arg value="${logLevel}" />
            <arg value="-war" />
            <arg value="${module.output.dir}" />
            <arg value="-style" />
            <arg value="${style}" />
            <arg value="-localWorkers" />
            <arg value="${localWorkers}" />
            <arg line="${assertions}" />
            <arg value="-strict" />
            <arg line="${extraParams}" />
            <arg value="${module}" />

            <sysproperty key="vFailIfNotSerializable" value="true" />

            <jvmarg value="-Xss8M" />
            <jvmarg value="-Xmx1G" />
            <jvmarg value="-XX:MaxPermSize=256M" />
            <jvmarg value="-Djava.awt.headless=true" />
            <jvmarg value="-Dgwt.usearchives=${gwt.usearchives}" />
            <jvmarg value="-Dgwt.persistentunitcache=${gwt.persistentunitcache}" />
        </java>
    </target>
    <target name="vaadinPush.js" depends="resolve">
        <ant antfile="${basedir}/push/build.xml" target="vaadinPush.js" dir="${basedir}/push" />
        <property name="js.output.dir" location="WebContent" />
        <property name="push.js.dir" location="${basedir}/push/result/js" />
        <copy todir="${js.output.dir}">
            <fileset dir="${push.js.dir}" includes="VAADIN/vaadinPush*">
            </fileset>
        </copy>
    </target>
    
    <target name="clean-unitcache">
        <delete dir="WebContent/VAADIN/gwt-unitCache" />
    </target>
</project>
